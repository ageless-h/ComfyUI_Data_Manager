# 提案：添加 Playwright E2E 测试并提高覆盖率

**状态**: 草案
**创建日期**: 2026-01-16
**优先级**: 中等

## 问题陈述

### 当前状态

1. **前端测试覆盖率不足**
   - 当前覆盖率阈值仅 38%（基于 vitest.config.ts）
   - 需要提升到 80% 以上

2. **缺少 E2E 测试**
   - 现有测试都是单元/组件测试（Vitest + Happy DOM）
   - 缺少真实浏览器环境的端到端测试
   - 无法验证完整的用户交互流程

3. **测试文件结构需优化**
   - 现有测试分散在 `frontend/src/` 各目录
   - 缺少专门的测试目录结构

## 目标

### 主要目标

1. **添加 Playwright E2E 测试**
   - 安装和配置 Playwright
   - 创建 E2E 测试覆盖核心用户流程
   - 确保测试成功率 100%

2. **提高测试覆盖率到 80% 以上**
   - 补充单元测试覆盖未测试的代码
   - 添加组件测试覆盖交互逻辑
   - 添加 API 客户端测试

3. **优化测试文件结构**
   - 创建清晰的测试目录结构
   - 分离单元测试、组件测试和 E2E 测试
   - 添加测试文档

## 影响范围

### 涉及目录

- `frontend/tests/` - 新建统一的测试目录
- `frontend/e2e/` - Playwright E2E 测试
- `frontend/src/` - 现有源代码和 `.test.ts` 文件
- `frontend/` - 配置文件更新

### 测试类型

| 测试类型 | 框架 | 环境 | 用途 |
|---------|------|------|------|
| 单元测试 | Vitest | Happy DOM | 测试函数和类 |
| 组件测试 | Vitest | Happy DOM | 测试 Vue 组件 |
| E2E 测试 | Playwright | 真实浏览器 | 测试完整流程 |

## 提案方案

### 新测试目录结构

```
frontend/
├── src/                     # 源代码（现有 .test.ts 文件保留）
├── tests/                   # 新建统一测试目录
│   ├── unit/               # 单元测试（从 src 迁移）
│   │   ├── utils/
│   │   ├── api/
│   │   └── core/
│   ├── components/         # 组件测试（从 src 迁移）
│   │   └── ui/
│   ├── fixtures/           # 测试数据和 mock
│   │   ├── api-responses.ts
│   │   └── test-data.ts
│   ├── setup.ts            # 测试配置
│   └── README.md           # 测试文档
├── e2e/                    # Playwright E2E 测试
│   ├── file-manager.spec.ts
│   ├── settings.spec.ts
│   ├── preview.spec.ts
│   └── README.md
├── vitest.config.ts        # 更新配置
├── playwright.config.ts    # 新建 Playwright 配置
└── package.json            # 添加 Playwright 依赖
```

### E2E 测试场景

1. **文件管理器操作**
   - 打开文件管理器
   - 浏览目录
   - 搜索文件
   - 预览文件

2. **设置面板**
   - 打开设置
   - 修改配置
   - 保存设置

3. **文件预览**
   - 图像预览
   - 视频预览
   - 文档预览

### 覆盖率目标

| 模块 | 当前覆盖率 | 目标覆盖率 |
|------|-----------|-----------|
| `api/` | ~40% | 85% |
| `utils/` | ~60% | 90% |
| `core/` | ~30% | 80% |
| `ui/` | ~20% | 75% |
| **总体** | 38% | **80%** |

## 实施步骤

1. 安装和配置 Playwright
2. 创建新的测试目录结构
3. 迁移现有测试文件到 `tests/` 目录
4. 编写 E2E 测试用例
5. 补充单元测试提高覆盖率
6. 更新 CI/CD 配置
7. 运行并验证所有测试通过

## 验收标准

- [ ] Playwright 安装并配置完成
- [ ] 新测试目录结构创建完成
- [ ] 现有测试迁移到新目录
- [ ] E2E 测试覆盖核心用户流程
- [ ] 所有测试通过（成功率 100%）
- [ ] 覆盖率报告显示 ≥ 80%
- [ ] CI/CD 集成完成
- [ ] 测试文档更新完成

## 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| Playwright 测试不稳定 | 高 | 使用稳定的选择器，添加等待逻辑 |
| 覆盖率目标难以达成 | 中 | 分阶段实施，优先核心模块 |
| 测试执行时间长 | 中 | 并行运行测试，使用 CI 缓存 |
