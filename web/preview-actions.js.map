{"version":3,"mappings":"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","names":["previewFile","path","FileManagerState","__vitePreload","n","fmState","content","floatingBtn","ext","getExt","fileName","fileType","getTypeByExt","previewHTML","canOpenExternally","FILE_TYPES","imageUrl","getPreviewUrl","imageId","audioUrl","escapeHtml","videoUrl","videoId","createVideoPreviewHTML","formatName","response","text","highlightCode","highlightCode2","createCodePreviewHTML","docUrl","createDocumentPreviewHTML","createSpreadsheetPreviewHTML","theme","getComfyTheme","icon","color","setupVideoControls","setupDocFullscreenControls","openFloatingPreview","updateStatus","updateFileInfo","video","playBtn","volumeBtn","fullscreenBtn","timeDisplay","current","formatTime","duration","seconds","mins","secs","maxLength","LIMITS","displayText","getFileName","buffer","loadScript","mammoth","result","contentId","error","parseSpreadsheet","parseSpreadsheet2","rows","createTableHTML","createTableHTML2","infoSection","info","getFileInfo","formatSize","btn"],"ignoreList":[],"sources":["../frontend/src/ui/components/preview-actions.ts"],"sourcesContent":["/**\n * ComfyUI Data Manager - Preview Actions Component\n */\n\nimport { FILE_TYPES, LIMITS } from '../../core/constants.js'\nimport { getTypeByExt } from '../../utils/file-type.js'\nimport { getPreviewUrl, getFileInfo } from '../../api/endpoints/file.js'\nimport { escapeHtml, formatSize } from '../../utils/format.js'\nimport { updateStatus, getFileName, getExt } from '../../utils/helpers.js'\nimport { loadScript } from '../../utils/script.js'\nimport { getComfyTheme } from '../../utils/theme.js'\nimport type { FileItem } from '../../core/state.js'\n\n// Re-export highlight functions\nexport {\n  highlightCode,\n  highlightJSON,\n  highlightPython,\n  highlightJavaScript,\n  highlightHTML,\n  highlightCSS,\n  highlightYAML,\n  highlightXML,\n  highlightGeneric,\n} from '../../utils/syntax-highlight.js'\n\n// Re-export table functions\nexport {\n  createTableHTML,\n  setupTableControls,\n  createEmptyTableHTML,\n  createUnsupportedTableHTML,\n  createTableErrorHTML,\n  parseSpreadsheet,\n} from '../../utils/table.js'\n\n/**\n * Preview file\n * @param path - File path\n */\nexport async function previewFile(path: string): Promise<void> {\n  const { FileManagerState } = await import('../../core/state.js')\n  const state = await import('../../core/state.js')\n  const fmState = state.FileManagerState\n\n  // Save current preview file\n  fmState.currentPreviewFile = path\n\n  const content = document.getElementById('dm-preview-content')\n  const floatingBtn = document.getElementById('dm-open-floating-preview-btn')\n\n  if (!content) return\n\n  content.innerHTML = `\n    <div class=\"dm-panel-loading\" style=\"text-align: center; padding: 20px;\">\n      <i class=\"pi pi-spin pi-spinner\"></i>\n    </div>\n  `\n\n  const ext = getExt(path)\n  const fileName = path.split(/[/\\\\]/).pop() || ''\n  const fileType = getTypeByExt(ext)\n\n  try {\n    let previewHTML = ''\n    let canOpenExternally = false\n\n    // Image preview\n    // Note: Image zoom controls are in the toolbar (right section), not embedded\n    if (FILE_TYPES.image.exts.includes(ext)) {\n      const imageUrl = getPreviewUrl(path)\n      const imageId = `dm-panel-image-${Date.now()}`\n      previewHTML = `\n        <div style=\"display: flex; flex-direction: column; gap: 0;\">\n          <div class=\"dm-image-preview-container\" style=\"position: relative; overflow: hidden; flex: 1; display: flex; align-items: center; justify-content: center;\">\n            <img id=\"${imageId}\" src=\"${imageUrl}\"\n                 class=\"dm-panel-preview-image dm-zoomable-image\"\n                 style=\"max-width: 100%; max-height: 400px; border-radius: 8px; border: 1px solid;\n                        transform-origin: center center; will-change: transform;\"\n                 onerror=\"this.parentElement.innerHTML='<div class=\\\\'dm-error-message\\\\' style=\\\\'padding: 20px;\\\\'>无法加载图像</div>'\">\n          </div>\n        </div>\n      `\n      canOpenExternally = true\n\n      // Store image ID for toolbar controls\n      ;(content as unknown as { _imageId?: string })._imageId = imageId\n    }\n    // Audio preview\n    else if (FILE_TYPES.audio.exts.includes(ext)) {\n      const audioUrl = getPreviewUrl(path)\n      previewHTML = `\n        <div class=\"dm-panel-audio-preview\" style=\"text-align: center; padding: 20px;\">\n          <i class=\"pi pi-volume-up dm-audio-icon\" style=\"font-size: 64px;\"></i>\n          <div class=\"dm-preview-filename\" style=\"margin-top: 15px;\">${escapeHtml(fileName)}</div>\n          <audio controls style=\"width: 100%; margin-top: 15px;\">\n            <source src=\"${audioUrl}\" type=\"audio/mpeg\">\n          </audio>\n        </div>\n      `\n      canOpenExternally = true\n    }\n    // Video preview\n    else if (FILE_TYPES.video.exts.includes(ext)) {\n      const videoUrl = getPreviewUrl(path)\n      const videoId = `dm-panel-video-${Date.now()}`\n      previewHTML = createVideoPreviewHTML(videoId, videoUrl)\n      canOpenExternally = true\n    }\n    // External video format preview (.avi, etc.)\n    else if (FILE_TYPES.videoExternal?.exts.includes(ext)) {\n      const formatName = ext.toUpperCase().replace('.', '')\n      previewHTML = `\n        <div class=\"dm-external-video\" style=\"text-align: center; padding: 40px;\">\n          <i class=\"pi pi-video dm-external-video-icon\" style=\"font-size: 64px; margin-bottom: 15px;\"></i>\n          <div class=\"dm-preview-filename\" style=\"margin-bottom: 15px; font-size: 16px;\">${escapeHtml(fileName)}</div>\n          <div class=\"dm-external-video-type\" style=\"font-size: 14px; font-weight: 600; margin-bottom: 15px;\">${formatName} 格式</div>\n          <div class=\"dm-external-video-desc\" style=\"margin-top: 10px; font-size: 12px; max-width: 300px; margin-left: auto; margin-right: auto;\">\n            此格式需要使用外部播放器打开<br>\n            <span class=\"dm-external-video-sub\">（VLC、Windows Media Player 等）</span>\n          </div>\n          <div class=\"dm-external-video-tip\" style=\"margin-top: 15px; padding: 10px; border-radius: 6px; font-size: 11px;\">\n            提示：点击下方\"打开\"按钮可用外部播放器播放\n          </div>\n        </div>\n      `\n      canOpenExternally = true\n    }\n    // Code preview\n    else if (FILE_TYPES.code.exts.includes(ext)) {\n      const response = await fetch(getPreviewUrl(path))\n      if (response.ok) {\n        const text = await response.text()\n        const { highlightCode } = await import('../../utils/syntax-highlight.js')\n        previewHTML = createCodePreviewHTML(text, ext, highlightCode)\n        canOpenExternally = true\n      } else {\n        throw new Error('Failed to load file')\n      }\n    }\n    // Document preview\n    else if (FILE_TYPES.document.exts.includes(ext)) {\n      const docUrl = getPreviewUrl(path)\n      previewHTML = await createDocumentPreviewHTML(path, ext, docUrl)\n      canOpenExternally = true\n    }\n    // Spreadsheet preview\n    else if (FILE_TYPES.spreadsheet.exts.includes(ext)) {\n      previewHTML = await createSpreadsheetPreviewHTML(path, ext)\n      canOpenExternally = true\n    }\n    // Other files\n    else {\n      const theme = getComfyTheme()\n      const icon = FILE_TYPES[fileType]?.icon || FILE_TYPES.unknown.icon\n      const color = FILE_TYPES[fileType]?.color || FILE_TYPES.unknown.color\n      previewHTML = `\n        <div style=\"text-align: center; padding: 30px;\">\n          <i class=\"pi ${icon}\" style=\"font-size: 64px; color: ${color};\"></i>\n          <div style=\"margin-top: 15px; color: ${theme.textPrimary}; font-size: 14px;\">${escapeHtml(fileName)}</div>\n          <div style=\"margin-top: 8px; color: ${theme.textSecondary}; font-size: 12px;\">此文件类型不支持预览</div>\n        </div>\n      `\n    }\n\n    content.innerHTML = previewHTML\n\n    // Bind video controls\n    if (FILE_TYPES.video.exts.includes(ext)) {\n      setupVideoControls(content)\n    }\n\n    // Bind document fullscreen controls\n    if (FILE_TYPES.document.exts.includes(ext)) {\n      setupDocFullscreenControls(content)\n    }\n\n    // Update button\n    if (floatingBtn) {\n      ;(floatingBtn as HTMLElement).style.display = 'block'\n      ;(floatingBtn as HTMLButtonElement).onclick = async () => {\n        const { openFloatingPreview } = await import('../floating/window.js')\n        openFloatingPreview(path, fileName)\n      }\n    }\n\n    updateStatus(`预览: ${fileName}`)\n\n    // Update file info area\n    updateFileInfo(path)\n  } catch (error) {\n    const theme = getComfyTheme()\n    content.innerHTML = `\n      <div style=\"text-align: center; padding: 20px; color: ${theme.errorColor};\">\n        <i class=\"pi pi-exclamation-triangle\" style=\"font-size: 32px;\"></i>\n        <div style=\"margin-top: 10px;\">加载预览失败</div>\n      </div>\n    `\n  }\n}\n\n/**\n * Create video preview HTML\n */\nfunction createVideoPreviewHTML(videoId: string, videoUrl: string): string {\n  return `\n    <div style=\"display: flex; flex-direction: column; gap: 0;\">\n      <div class=\"dm-panel-video-container\" style=\"position: relative; border-radius: 8px; overflow: hidden;\">\n        <video id=\"${videoId}\" controls preload=\"metadata\" style=\"width: 100%; max-height: 300px; display: block; object-fit: contain;\">\n          <source src=\"${videoUrl}\" type=\"video/mp4\">\n        </video>\n      </div>\n      <div id=\"${videoId}-controls\" class=\"dm-video-controls-panel\" style=\"display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px; border-radius: 0 0 8px 8px; margin-top: -2px;\">\n        <button class=\"comfy-btn dm-video-play-btn\" data-video-id=\"${videoId}\" title=\"播放\">\n          <i class=\"pi pi-play\"></i> 播放\n        </button>\n        <span id=\"${videoId}-time\" class=\"dm-video-time-display\">0:00 / 0:00</span>\n        <button class=\"comfy-btn dm-video-volume-btn\" data-video-id=\"${videoId}\" title=\"音量\">\n          <i class=\"pi pi-volume-up\"></i>\n        </button>\n        <button class=\"comfy-btn dm-video-fullscreen-btn\" data-video-id=\"${videoId}\" title=\"视频全屏\">\n          <i class=\"pi pi-arrows-alt\"></i>\n        </button>\n      </div>\n    </div>\n  `\n}\n\n/**\n * Setup video controls\n */\nfunction setupVideoControls(content: HTMLElement): void {\n  const video = content.querySelector('video') as HTMLVideoElement\n  const playBtn = content.querySelector('.dm-video-play-btn') as HTMLButtonElement\n  const volumeBtn = content.querySelector('.dm-video-volume-btn') as HTMLButtonElement\n  const fullscreenBtn = content.querySelector('.dm-video-fullscreen-btn') as HTMLButtonElement\n  const timeDisplay = content.querySelector(`[id$=\"-time\"]`) as HTMLElement\n\n  if (!video || !playBtn) return\n\n  playBtn.addEventListener('click', () => {\n    if (video.paused) {\n      video.play().then(() => {\n        playBtn.innerHTML = '<i class=\"pi pi-pause\"></i> 暂停'\n      })\n    } else {\n      video.pause()\n      playBtn.innerHTML = '<i class=\"pi pi-play\"></i> 播放'\n    }\n  })\n\n  video.addEventListener('play', () => {\n    playBtn.innerHTML = '<i class=\"pi pi-pause\"></i> 暂停'\n  })\n\n  video.addEventListener('pause', () => {\n    playBtn.innerHTML = '<i class=\"pi pi-play\"></i> 播放'\n  })\n\n  video.addEventListener('timeupdate', () => {\n    const current = formatTime(video.currentTime)\n    const duration = formatTime(video.duration)\n    timeDisplay.textContent = `${current} / ${duration}`\n  })\n\n  if (volumeBtn) {\n    volumeBtn.addEventListener('click', () => {\n      video.muted = !video.muted\n      volumeBtn.innerHTML = video.muted\n        ? '<i class=\"pi pi-volume-off\"></i>'\n        : '<i class=\"pi pi-volume-up\"></i>'\n    })\n  }\n\n  if (fullscreenBtn) {\n    fullscreenBtn.addEventListener('click', () => {\n      if (video.requestFullscreen) {\n        video.requestFullscreen()\n      }\n    })\n  }\n}\n\n/**\n * Format time in MM:SS format\n */\nfunction formatTime(seconds: number): string {\n  const mins = Math.floor(seconds / 60)\n  const secs = Math.floor(seconds % 60)\n  return `${mins}:${secs.toString().padStart(2, '0')}`\n}\n\n/**\n * Create code preview HTML\n */\nfunction createCodePreviewHTML(\n  text: string,\n  ext: string,\n  highlightCode: (code: string, ext: string) => string\n): string {\n  // Limit code length to prevent performance issues\n  const maxLength = LIMITS.MAX_CODE_LENGTH\n  const displayText =\n    text.length > maxLength ? text.substring(0, maxLength) + '\\n\\n... (文件过大，已截断)' : text\n  const highlighted = highlightCode(displayText, ext)\n  return `\n    <div class=\"dm-code-preview\" style=\"width: 100%; padding: 15px;\n                font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; line-height: 1.5;\n                overflow-x: auto; max-height: 400px; overflow-y: auto; border-radius: 0;\">\n      <pre class=\"dm-code-content\" style=\"margin: 0; white-space: pre-wrap;\">${highlighted}</pre>\n    </div>\n  `\n}\n\n/**\n * Create document preview HTML\n */\nasync function createDocumentPreviewHTML(\n  path: string,\n  ext: string,\n  docUrl: string\n): Promise<string> {\n  const fileName = getFileName(path)\n\n  if (ext === '.md') {\n    // Use iframe for backend markdown rendering\n    return `\n      <div style=\"display: flex; flex-direction: column; gap: 0;\">\n        <div style=\"width: 100%; height: 400px; overflow: hidden; flex: 1;\">\n          <iframe src=\"${docUrl}\" style=\"width: 100%; height: 100%; border: none;\"></iframe>\n        </div>\n        <div class=\"dm-doc-controls\" style=\"display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px;\">\n          <button class=\"comfy-btn dm-doc-fullscreen-btn\" data-doc-path=\"${escapeHtml(path)}\" title=\"全屏\">\n            <i class=\"pi pi-window-maximize\"></i> 全屏\n          </button>\n        </div>\n      </div>\n    `\n  }\n\n  if (ext === '.pdf') {\n    return `\n      <div style=\"display: flex; flex-direction: column; gap: 0; height: 100%;\">\n        <div style=\"width: 100%; flex: 1; min-height: 400px; overflow: hidden;\">\n          <embed src=\"${docUrl}\" type=\"application/pdf\" style=\"width: 100%; height: 100%; border: none;\" />\n        </div>\n        <div class=\"dm-doc-controls\" style=\"display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px;\">\n          <button class=\"comfy-btn dm-doc-fullscreen-btn\" data-doc-path=\"${escapeHtml(path)}\" title=\"全屏\">\n            <i class=\"pi pi-window-maximize\"></i> 全屏\n          </button>\n        </div>\n      </div>\n    `\n  }\n\n  // DOCX preview with mammoth.js\n  if (ext === '.docx') {\n    try {\n      const response = await fetch(docUrl)\n      if (!response.ok) throw new Error('Failed to load file')\n\n      const buffer = await response.arrayBuffer()\n\n      // Dynamically load mammoth.js\n      await loadScript(\n        'https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js'\n      )\n\n      const mammoth = (\n        window as unknown as {\n          mammoth?: { convertToHtml(options: { arrayBuffer: ArrayBuffer }): { value: string } }\n        }\n      ).mammoth\n      if (!mammoth) throw new Error('mammoth.js not available')\n\n      const result = mammoth.convertToHtml({ arrayBuffer: buffer })\n      const contentId = `dm-doc-content-${Date.now()}`\n\n      return `\n        <div style=\"display: flex; flex-direction: column; gap: 0; height: 100%;\">\n          <div id=\"${contentId}\" class=\"dm-docx-content\"\n               style=\"flex: 1; overflow-y: auto; padding: 20px; box-sizing: border-box;\">\n            <style>\n              #${contentId} img { max-width: 100%; height: auto; display: inline-block; margin: 10px 0; }\n              #${contentId} p { word-wrap: break-word; overflow-wrap: break-word; margin: 0.5em 0; }\n              #${contentId} table { max-width: 100%; overflow: auto; display: block; margin: 10px 0; }\n            </style>\n            ${result.value}\n          </div>\n          <div class=\"dm-doc-controls\" style=\"display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px;\">\n            <button class=\"comfy-btn dm-doc-fullscreen-btn\" data-doc-path=\"${escapeHtml(path)}\" title=\"全屏\">\n              <i class=\"pi pi-window-maximize\"></i> 全屏\n            </button>\n          </div>\n        </div>\n      `\n    } catch (error) {\n      return `\n        <div style=\"text-align: center; padding: 40px; color: #e74c3c;\">\n          <i class=\"pi pi-exclamation-triangle\" style=\"font-size: 48px;\"></i>\n          <div style=\"margin-top: 15px;\">${escapeHtml(fileName)}</div>\n          <div style=\"margin-top: 10px;\">预览加载失败</div>\n          <div style=\"margin-top: 5px; font-size: 11px;\">${escapeHtml((error as Error).message)}</div>\n        </div>\n      `\n    }\n  }\n\n  // DOC format - not supported\n  if (ext === '.doc') {\n    const theme = getComfyTheme()\n    return `\n      <div style=\"text-align: center; padding: 40px;\">\n        <i class=\"pi pi-file-word\" style=\"font-size: 64px; color: ${theme.textSecondary};\"></i>\n        <div style=\"margin-top: 15px;\">${escapeHtml(fileName)}</div>\n        <div style=\"margin-top: 10px;\">.doc 格式暂不支持预览</div>\n        <div style=\"margin-top: 5px; font-size: 11px;\">请转换为 .docx 或点击\"打开\"按钮</div>\n      </div>\n    `\n  }\n\n  // TXT/RTF text preview\n  if (ext === '.txt' || ext === '.rtf') {\n    try {\n      const response = await fetch(docUrl)\n      if (!response.ok) throw new Error('Failed to load file')\n\n      const text = await response.text()\n      const contentId = `dm-doc-content-${Date.now()}`\n\n      return `\n        <div style=\"display: flex; flex-direction: column; gap: 0; height: 100%;\">\n          <div id=\"${contentId}\" class=\"dm-text-content\"\n               style=\"flex: 1; overflow-y: auto; padding: 15px; box-sizing: border-box;\n                      font-family: 'Consolas', 'Monaco', monospace;\n                      font-size: 13px; line-height: 1.6;\n                      word-break: break-word; white-space: pre-wrap;\">${escapeHtml(text)}</div>\n          <div class=\"dm-doc-controls\" style=\"display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px;\">\n            <button class=\"comfy-btn dm-doc-fullscreen-btn\" data-doc-path=\"${escapeHtml(path)}\" title=\"全屏\">\n              <i class=\"pi pi-window-maximize\"></i> 全屏\n            </button>\n          </div>\n        </div>\n      `\n    } catch (error) {\n      return `\n        <div style=\"text-align: center; padding: 40px; color: #e74c3c;\">\n          <i class=\"pi pi-exclamation-triangle\" style=\"font-size: 48px;\"></i>\n          <div style=\"margin-top: 15px;\">${escapeHtml(fileName)}</div>\n          <div style=\"margin-top: 10px;\">预览加载失败</div>\n          <div style=\"margin-top: 5px; font-size: 11px;\">${escapeHtml((error as Error).message)}</div>\n        </div>\n      `\n    }\n  }\n\n  const theme = getComfyTheme()\n  return `\n    <div style=\"text-align: center; padding: 40px;\">\n      <i class=\"pi pi-file\" style=\"font-size: 64px; color: ${theme.textSecondary};\"></i>\n      <div style=\"margin-top: 15px; font-size: 14px;\">${escapeHtml(fileName)}</div>\n      <div style=\"margin-top: 8px; font-size: 12px; color: ${theme.textSecondary};\">文档预览</div>\n    </div>\n  `\n}\n\n/**\n * Create spreadsheet preview HTML\n */\nasync function createSpreadsheetPreviewHTML(path: string, ext: string): Promise<string> {\n  const { parseSpreadsheet } = await import('../../utils/table.js')\n  try {\n    const rows = await parseSpreadsheet(path, ext)\n    const { createTableHTML } = await import('../../utils/table.js')\n    return createTableHTML(rows, { type: 'panel', path })\n  } catch (error) {\n    const theme = getComfyTheme()\n    return `\n      <div style=\"text-align: center; padding: 40px; color: ${theme.errorColor};\">\n        <i class=\"pi pi-exclamation-triangle\" style=\"font-size: 48px;\"></i>\n        <div style=\"margin-top: 15px;\">表格解析失败</div>\n        <div style=\"margin-top: 5px; font-size: 11px;\">${escapeHtml((error as Error).message)}</div>\n      </div>\n    `\n  }\n}\n\n/**\n * Update file info area\n */\nasync function updateFileInfo(path: string): Promise<void> {\n  const infoSection = document.getElementById('dm-file-info')\n  if (!infoSection) return\n\n  try {\n    const info = await getFileInfo(path)\n    infoSection.innerHTML = `\n      <div style=\"display: flex; justify-content: space-between; margin-bottom: 5px;\">\n        <span>文件名:</span>\n        <span>${escapeHtml(info.name)}</span>\n      </div>\n      <div style=\"display: flex; justify-content: space-between; margin-bottom: 5px;\">\n        <span><i class=\"pi pi-database\"></i> 大小:</span>\n        <span>${formatSize(info.size)}</span>\n      </div>\n      <div style=\"display: flex; justify-content: space-between;\">\n        <span><i class=\"pi pi-clock\"></i> 修改时间:</span>\n        <span>${info.modified ? new Date(info.modified).toLocaleString('zh-CN') : '-'}</span>\n      </div>\n    `\n  } catch (error) {\n    infoSection.innerHTML = `<div style=\"text-align: center;\">无法获取文件信息</div>`\n  }\n}\n\n/**\n * Setup image zoom controls\n * @param imageId - Image element ID\n */\nexport function setupImageZoomControls(imageId: string): void {\n  const image = document.getElementById(imageId) as HTMLImageElement\n  if (!image) return\n\n  const zoomOutBtn = document.querySelector(\n    `.dm-zoom-out-btn[data-image-id=\"${imageId}\"]`\n  ) as HTMLButtonElement\n  const zoomInBtn = document.querySelector(\n    `.dm-zoom-in-btn[data-image-id=\"${imageId}\"]`\n  ) as HTMLButtonElement\n  const resetBtn = document.querySelector(\n    `.dm-zoom-reset-btn[data-image-id=\"${imageId}\"]`\n  ) as HTMLButtonElement\n  const zoomDisplay = document.getElementById(`${imageId}-zoom`) as HTMLElement\n\n  if (!zoomOutBtn || !zoomInBtn || !zoomDisplay) return\n\n  let zoom = 100\n  let imageTranslateX = 0\n  let imageTranslateY = 0\n  let isDraggingImage = false\n  let dragStart = { x: 0, y: 0 }\n\n  function updateZoom(): void {\n    const scale = zoom / 100\n    // Translate first, then scale - this way drag distance is consistent\n    image.style.transform = `translate(${imageTranslateX}px, ${imageTranslateY}px) scale(${scale})`\n    if (zoomDisplay) zoomDisplay.textContent = `${zoom}%`\n\n    // Remove max-width/max-height constraints when zoomed in\n    if (zoom > 100) {\n      image.style.maxWidth = 'none'\n      image.style.maxHeight = 'none'\n    } else {\n      image.style.maxWidth = '100%'\n      image.style.maxHeight = '100%'\n    }\n  }\n\n  if (zoomInBtn) {\n    zoomInBtn.addEventListener('click', () => {\n      zoom = Math.min(zoom + LIMITS.DEFAULT_ZOOM_STEP, LIMITS.MAX_ZOOM_DISPLAY)\n      updateZoom()\n    })\n  }\n\n  if (zoomOutBtn) {\n    zoomOutBtn.addEventListener('click', () => {\n      zoom = Math.max(zoom - LIMITS.DEFAULT_ZOOM_STEP, LIMITS.MIN_ZOOM_DISPLAY)\n      updateZoom()\n    })\n  }\n\n  if (resetBtn) {\n    resetBtn.addEventListener('click', () => {\n      // Reset to original state\n      zoom = 100\n      imageTranslateX = 0\n      imageTranslateY = 0\n      updateZoom()\n    })\n  }\n\n  // Mouse wheel zoom\n  const container = image.parentElement\n  if (container) {\n    container.addEventListener(\n      'wheel',\n      (e) => {\n        e.preventDefault()\n        const delta = e.deltaY > 0 ? -LIMITS.DEFAULT_ZOOM_STEP : LIMITS.DEFAULT_ZOOM_STEP\n        zoom = Math.max(LIMITS.MIN_ZOOM_DISPLAY, Math.min(LIMITS.MAX_ZOOM_DISPLAY, zoom + delta))\n        updateZoom()\n      },\n      { passive: false }\n    )\n  }\n\n  // Image drag (pan)\n  image.addEventListener('mousedown', (e) => {\n    if (zoom <= 100) return\n    isDraggingImage = true\n    dragStart = { x: e.clientX - imageTranslateX, y: e.clientY - imageTranslateY }\n    image.style.cursor = 'grabbing'\n  })\n\n  document.addEventListener('mousemove', (e) => {\n    if (!isDraggingImage) return\n    imageTranslateX = e.clientX - dragStart.x\n    imageTranslateY = e.clientY - dragStart.y\n    updateZoom()\n  })\n\n  document.addEventListener('mouseup', () => {\n    if (isDraggingImage) {\n      isDraggingImage = false\n      image.style.cursor = 'grab'\n    }\n  })\n}\n\n/**\n * Setup document fullscreen controls\n * @param content - Content container element\n */\nfunction setupDocFullscreenControls(content: HTMLElement): void {\n  const fullscreenBtns = content.querySelectorAll('.dm-doc-fullscreen-btn')\n  fullscreenBtns.forEach((btn) => {\n    const path = (btn as HTMLElement).getAttribute('data-doc-path')\n    if (path) {\n      btn.addEventListener('click', async () => {\n        const fileName = path.split(/[\\\\/]/).pop() || path\n        const { openFloatingPreview } = await import('../floating/window.js')\n        openFloatingPreview(path, fileName)\n      })\n    }\n  })\n}\n"],"file":"preview-actions.js"}