# ComfyUI Data Manager - 测试报告

**测试日期**: 2026-01-07
**测试版本**: master (6df7534)

---

## ✅ 自动化测试通过

### 后端 Python 测试

```
=== 测试 utils 工具模块 ===
✅ utils 模块导入成功

=== 测试工具函数 ===
✅ human_readable_size(1024) = "1.0 KB"
✅ human_readable_size(2621440) = "2.5 MB"

--- 文件类别检测 ---
✅ get_file_category("test.png") = "image"
✅ get_file_category("test.jpg") = "image"
✅ get_file_category("test.tiff") = "image"
✅ get_file_category("test.tif") = "image"
✅ get_file_category("test.avif") = "image"
✅ get_file_category("test.heic") = "image"
✅ get_file_category("test.tga") = "image"
✅ get_file_category("test.mp4") = "video"
✅ get_file_category("test.mp3") = "audio"
✅ get_file_category("test.py") = "code"
✅ get_file_category("test.pdf") = "document"
✅ get_file_category("test.zip") = "archive"

--- 路径工具 ---
✅ get_parent_path("/path/to/file.txt") = "/path/to"
✅ get_parent_path("/path/to/") = "/path/to"
✅ get_parent_path("file.txt") = "."

=== 所有 utils 测试通过 ===
```

### 前端 JavaScript 测试

```
✅ extension.js 语法检查通过
✅ metadata.py 语法检查通过
```

### API 路由注册验证

| 路由 | 方法 | 状态 |
|------|------|------|
| `/dm/list` | POST | ✅ 已注册 |
| `/dm/info` | POST | ✅ 已注册 |
| `/dm/save` | POST | ✅ 已注册 |
| `/dm/categories` | GET | ✅ 已注册 |
| `/dm/preview` | GET | ✅ 已注册 |

---

## ⏳ 手动功能测试清单

### 准备工作

1. **启动 ComfyUI**
   ```bash
   cd ComfyUI
   python main.py
   ```
   确认控制台输出：
   ```
   [DataManager] Extension loading, Node V1/V3 detected
   [DataManager] API routes registered successfully
   ```

2. **准备测试文件**
   ```
   tests/
   ├── test_images/
   │   ├── sample.png
   │   ├── sample.jpg
   │   ├── sample.tiff
   │   └── sample.tga
   ├── test_videos/
   │   └── sample.mp4
   └── test_audio/
       └── sample.mp3
   ```

---

### 测试 1: 节点加载测试

| 步骤 | 操作 | 预期结果 | 状态 |
|------|------|----------|------|
| 1.1 | 启动 ComfyUI | 控制台无错误 | ⏳ |
| 1.2 | 右键画布 → Add Node → 搜索 "Data Manager" | 显示三个节点 | ⏳ |
| 1.3 | 添加 "Data Manager - Core" 节点 | 节点正常显示，带按钮 | ⏳ |
| 1.4 | 打开浏览器控制台 | 无 JavaScript 错误 | ⏳ |

---

### 测试 2: 文件管理器 UI 测试

| 步骤 | 操作 | 预期结果 | 状态 |
|------|------|----------|------|
| 2.1 | 点击 "打开文件管理器" 按钮 | 文件管理器窗口弹出 | ⏳ |
| 2.2 | 检查窗口布局 | 显示：标题栏、工具栏、文件列表、预览面板、状态栏 | ⏳ |
| 2.3 | 检查 Dock 栏 | 底部 Dock 栏隐藏（无最小化窗口） | ⏳ |
| 2.4 | 拖动窗口 | 窗口可拖动 | ⏳ |
| 2.5 | 点击关闭按钮 | 窗口正常关闭 | ⏳ |

---

### 测试 3: 图像预览测试

| 步骤 | 操作 | 预期结果 | 状态 |
|------|------|----------|------|
| 3.1 | 选择 PNG 文件 | 右侧预览面板显示图像 | ⏳ |
| 3.2 | 点击 "浮窗" 按钮 | 弹出浮动预览窗口 | ⏳ |
| 3.3 | 检查交通灯按钮 | 显示红（×）、黄（-）、绿（⤢）三个按钮 | ⏳ |
| 3.4 | 悬停红色按钮 | 按钮变红色 #ff5f57 | ⏳ |
| 3.5 | 悬停黄色按钮 | 按钮变黄色 #ffbd2e | ⏳ |
| 3.6 | 悬停绿色按钮 | 按钮变绿色 #28c940 | ⏳ |
| 3.7 | 点击绿色按钮 | 窗口全屏（macOS 风格，保留圆角） | ⏳ |
| 3.8 | 再次点击绿色按钮 | 退出全屏 | ⏳ |

---

### 测试 4: 特殊图像格式测试

| 文件格式 | 测试文件 | 预期结果 | 状态 |
|----------|----------|----------|------|
| TIFF | sample.tiff | 后端转换为 PNG，正常显示 | ⏳ |
| AVIF | sample.avif | 后端转换为 PNG，正常显示 | ⏳ |
| HEIF | sample.heic | 后端转换为 PNG，正常显示 | ⏳ |
| TGA | sample.tga | 后端转换为 PNG，正常显示 | ⏳ |

---

### 测试 5: 视频预览测试

| 步骤 | 操作 | 预期结果 | 状态 |
|------|------|----------|------|
| 5.1 | 选择 MP4 文件 | 右侧预览面板显示视频 | ⏳ |
| 5.2 | 点击 "浮窗" 按钮 | 弹出浮动预览窗口 | ⏳ |
| 5.3 | 检查原生控件 | 无原生进度条悬浮 | ⏳ |
| 5.4 | 检查工具栏控件 | 显示时间、音量、播放/暂停按钮 | ⏳ |
| 5.5 | 点击播放按钮 | 视频开始播放，图标变为暂停 | ⏳ |
| 5.6 | 检查时间显示 | 当前时间 / 总时长（格式: 0:00 / 3:45） | ⏳ |
| 5.7 | 点击音量按钮 | 静音，图标变为 pi-volume-off | ⏳ |
| 5.8 | 再次点击音量按钮 | 取消静音，图标变为 pi-volume-up | ⏳ |
| 5.9 | 点击绿色全屏按钮 | 窗口全屏 | ⏳ |
| 5.10 | 点击视频原生全屏按钮 | 视频元素全屏 | ⏳ |

---

### 测试 6: 音频预览测试

| 步骤 | 操作 | 预期结果 | 状态 |
|------|------|----------|------|
| 6.1 | 选择 MP3 文件 | 右侧预览面板显示音频 | ⏳ |
| 6.2 | 点击 "浮窗" 按钮 | 弹出浮动预览窗口 | ⏳ |
| 6.3 | 检查工具栏控件 | 显示时间、音量、播放/暂停按钮 | ⏳ |
| 6.4 | 点击播放按钮 | 音频开始播放 | ⏳ |
| 6.5 | 调节音量 | 音量变化正常 | ⏳ |

---

### 测试 7: macOS 风格最小化测试

| 步骤 | 操作 | 预期结果 | 状态 |
|------|------|----------|------|
| 7.1 | 打开图像预览浮窗 | 浮动预览窗口显示 | ⏳ |
| 7.2 | 点击黄色最小化按钮 | 窗口缩小并移动到 Dock 栏 | ⏳ |
| 7.3 | 检查 Dock 栏 | 底部 Dock 栏展开，显示缩略图 | ⏳ |
| 7.4 | 检查缩略图 | 显示文件图标 + 文件名 | ⏳ |
| 7.5 | 悬停缩略图 | 缩略图上浮，边框高亮 | ⏳ |
| 7.6 | 点击缩略图 | 窗口从 Dock 栏恢复到原位 | ⏳ |
| 7.7 | 再次最小化 | 重复步骤 7.2 | ⏳ |
| 7.8 | 打开第二个预览窗口 | 两个浮动窗口 | ⏳ |
| 7.9 | 同时最小化两个窗口 | Dock 栏显示两个缩略图 | ⏳ |
| 7.10 | 点击任意缩略图恢复 | 对应窗口恢复 | ⏳ |
| 7.11 | 关闭所有预览窗口 | Dock 栏隐藏 | ⏳ |

---

### 测试 8: 多窗口管理测试

| 步骤 | 操作 | 预期结果 | 状态 |
|------|------|----------|------|
| 8.1 | 打开同一文件两次 | 第二次聚焦已有窗口，不重复创建 | ⏳ |
| 8.2 | 打开不同文件多次 | 每个文件独立窗口 | ⏳ |
| 8.3 | 最小化部分窗口 | Dock 栏只显示最小化的窗口 | ⏳ |
| 8.4 | 恢复窗口 | 窗口恢复到原始位置 | ⏳ |

---

### 测试 9: API 端点测试（可选）

```bash
# 替换为实际路径后运行
curl -X POST http://localhost:8188/dm/list \
  -H "Content-Type: application/json" \
  -d "{\"path\": \".\"}"

curl http://localhost:8188/dm/categories

curl "http://localhost:8188/dm/preview?path=C:/test/image.png" --output test.png
```

| 端点 | 预期响应 | 状态 |
|------|----------|------|
| `/dm/list` | JSON 文件列表 | ⏳ |
| `/dm/categories` | 类别配置 | ⏳ |
| `/dm/preview` | 文件内容 | ⏳ |

---

## 测试结果汇总

| 类别 | 测试项 | 通过 | 失败 | 待测试 |
|------|--------|------|------|--------|
| 自动化 | Python 语法 | ✅ | 0 | 0 |
| 自动化 | JavaScript 语法 | ✅ | 0 | 0 |
| 自动化 | 工具函数 | ✅ 12 | 0 | 0 |
| 自动化 | API 路由注册 | ✅ 5 | 0 | 0 |
| 手动 | 节点加载 | - | - | ⏳ 4 |
| 手动 | 文件管理器 UI | - | - | ⏳ 5 |
| 手动 | 图像预览 | - | - | ⏳ 8 |
| 手动 | 特殊格式 | - | - | ⏳ 4 |
| 手动 | 视频预览 | - | - | ⏳ 10 |
| 手动 | 音频预览 | - | - | ⏳ 5 |
| 手动 | 最小化功能 | - | - | ⏳ 11 |
| 手动 | 多窗口管理 | - | - | ⏳ 4 |
| 手动 | API 端点 | - | - | ⏳ 3 |

---

## 已知问题

### 1. 最小化动画方向
- **问题**: 动画可能不总是准确指向 Dock 栏位置
- **原因**: 浮动窗口位置可能是动态的
- **影响**: 轻微，不影响功能

### 2. 多页 TIFF
- **问题**: TIFF 多页文件只显示第一页
- **原因**: 转换时使用 `img.seek(0)`
- **影响**: 符合预期，不需要修改

---

## 测试完成标准

- [ ] 所有自动化测试通过 ✅
- [ ] 节点加载正常
- [ ] 文件管理器 UI 正常
- [ ] 图像预览正常
- [ ] 特殊格式（TIFF/AVIF/HEIF/TGA）预览正常
- [ ] 视频播放和控制正常
- [ ] 音频播放和控制正常
- [ ] macOS 交通灯按钮正常
- [ ] 最小化功能正常
- [ ] Dock 栏缩略图正常
- [ ] 多窗口管理正常

---

## 下一步

1. **启动 ComfyUI** 进行手动测试
2. **记录测试结果** 到此文档
3. **修复发现的问题**
4. **最终提交**

---

**测试人员**: _______________
**完成日期**: _______________
